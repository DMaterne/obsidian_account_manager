/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var x=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var D=Object.prototype.hasOwnProperty;var I=(c,o)=>{for(var e in o)x(c,e,{get:o[e],enumerable:!0})},L=(c,o,e,t)=>{if(o&&typeof o=="object"||typeof o=="function")for(let s of O(o))!D.call(c,s)&&s!==e&&x(c,s,{get:()=>o[s],enumerable:!(t=G(o,s))||t.enumerable});return c};var R=c=>L(x({},"__esModule",{value:!0}),c);var W={};I(W,{default:()=>k});module.exports=R(W);var a=require("obsidian");function M(c){if(!c||typeof c!="object")return!1;let o=c,e=o.currentCharacter===null||typeof o.currentCharacter=="string"||typeof o.currentCharacter=="undefined",t=typeof o.isAuthenticated=="boolean"||typeof o.isAuthenticated=="undefined",s=typeof o.currentGroups=="undefined"||Array.isArray(o.currentGroups)&&o.currentGroups.every(n=>typeof n=="string");return e&&t&&s}var v="DnDAuth/users.json",C={currentCharacter:null,isAuthenticated:!1,currentGroups:[]};function $(c){let o="";for(let e of c)o+=String.fromCharCode(e);return btoa(o)}async function F(c){let o=new TextEncoder().encode(c),e=await crypto.subtle.digest("SHA-256",o);return $(new Uint8Array(e))}function N(c=16){let o=new Uint8Array(c);return crypto.getRandomValues(o),$(o)}function q(c){if(!c||typeof c!="object")return!1;let o=c;return Array.isArray(o.users)}function E(c,o,e){let t=c.createEl("button",{text:o});t.addClass("am-action-btn"),t.addEventListener("click",e)}function V(c){let o=c.split(`
`),e=[],t=!0,s=0;for(let r=0;r<o.length;r++){let i=o[r];if(i===void 0)continue;let u=i.trim();if(u==="---"){s=r+1;break}if(!u)continue;let l=u.match(/^groups\s*:\s*(.+)$/i);if(l&&l[1]){e=l[1].split(",").map(p=>p.trim()).filter(Boolean);continue}let d=u.match(/^requireAuth\s*:\s*(true|false)$/i);if(d&&d[1]){t=d[1].toLowerCase()==="true";continue}}let n=o.slice(s).join(`
`);return{groups:e,body:n,requireAuth:t}}var k=class extends a.Plugin{constructor(){super(...arguments);this.state={...C};this.statusEl=null}async onload(){let e=await this.loadData();this.state=M(e)?{...C,...e}:{...C},await this.ensureUsersFile(),this.statusEl=this.addStatusBarItem(),this.renderStatus(),this.statusEl&&(this.statusEl.addClass("am-status-clickable"),this.statusEl.addEventListener("click",()=>{new T(this.app,this).open()})),this.registerMarkdownCodeBlockProcessor("dndadmin",async(t,s)=>{var l;if(!this.isAdmin()){s.createEl("div",{text:"Admin only. \u{1F512}"});return}let n=s.createDiv(),r=n.createEl("button",{text:"Create / update user"});r.onclick=()=>{this.execCommand("account-manager:authentificator-admin-create-update-user")};let i=n.createEl("button",{text:"Regenerate report"});i.addClass("am-report-btn"),i.onclick=async()=>{await this.generateUserReportNote(),this.refreshAllMarkdownViews(),new a.Notice("Report updated")},s.createEl("hr");let u=await this.loadUsers();for(let d of u)s.createDiv({text:`${d.name} \u2014 ${((l=d.groups)!=null?l:[]).join(", ")||"-"}`})}),this.addCommand({id:"authentificator-admin-setup-admin-area",name:"Admin: setup admin area",callback:async()=>{if(!this.isAdmin()){new a.Notice("Admin only, please login as admin.");return}await this.ensureFolder("Admin Area"),await this.upsertFile("Admin Area/UserManagement.md",["---","dnd_access_groups: [admin]","dnd_require_auth: true","generated: true","---","","# Admin Area \u2013 User Management","","```dndadmin","mode: users","```",""].join(`
`)),await this.generateUserReportNote(),this.refreshAllMarkdownViews();let t=this.app.vault.getAbstractFileByPath("Admin Area/UserManagement.md");t instanceof a.TFile&&await this.app.workspace.getLeaf(!0).openFile(t),new a.Notice("Admin area created/updated.")}}),this.addCommand({id:"authentificator-select-character",name:"Select character",callback:async()=>{let t=await this.loadUsers(),s=await new Promise(n=>{new b(this.app,t,n).open()});s&&(this.state.currentCharacter=s.name,this.state.isAuthenticated=!1,this.state.currentGroups=[],await this.saveData(this.state),this.renderStatus(),this.refreshAllMarkdownViews(),new a.Notice(`Selected character: ${s.name}`))}}),this.addCommand({id:"authentificator-login",name:"Login (password)",callback:async()=>{var u;let t=this.state.currentCharacter;if(!t){new a.Notice("Select a character first.");return}let s=await new Promise(l=>{new B(this.app,l).open()});if(!s)return;if(!await this.verifyPassword(t,s)){this.state.isAuthenticated=!1,this.state.currentGroups=[],await this.saveData(this.state),this.renderStatus(),this.refreshAllMarkdownViews(),new a.Notice("Login failed.");return}let i=(await this.loadUsers()).find(l=>l.name===t);this.state.isAuthenticated=!0,this.state.currentGroups=((u=i==null?void 0:i.groups)!=null?u:[]).map(String),await this.saveData(this.state),this.renderStatus(),this.refreshAllMarkdownViews(),new a.Notice(`Logged in as ${t}`)}}),this.addCommand({id:"authentificator-logout",name:"Logout",callback:async()=>{this.state={...C},await this.saveData(this.state),this.renderStatus(),this.refreshAllMarkdownViews(),new a.Notice("Logged out.")}}),this.addCommand({id:"authentificator-open-gated-note",name:"Open gated note\u2026",callback:()=>{if(!this.isAdmin()&&!this.state.isAuthenticated){new a.Notice("Please login first.");return}new S(this.app,this).open()}}),this.addCommand({id:"authentificator-admin-create-update-user",name:"Admin: create/update user",callback:async()=>{if(!this.isAdmin()){new a.Notice("Admin only, please login as admin.");return}let t=await new Promise(h=>{new U(this.app,h).open()});if(!t)return;let s=t.name.trim(),n=t.password;if(!s)return void new a.Notice("User name cannot be empty.");if(!n)return void new a.Notice("Password cannot be empty.");let r=t.groups.split(",").map(h=>h.trim()).filter(Boolean);s==="Admin"&&!r.includes("admin")&&r.push("admin");let i=await this.loadUsers(),u=N(),l=await F(`${u}:${n}`),d=i.findIndex(h=>h.name===s),p={name:s,salt:u,hash:l,groups:r};d>=0?i[d]=p:i.push(p),await this.saveUsers(i),this.refreshAllMarkdownViews(),new a.Notice(`\u2705 Saved user: ${s}`)}}),this.addCommand({id:"authentificator-admin-toggle-group",name:"Admin: toggle group for user",callback:async()=>{var h,f,w,m,y;if(!this.isAdmin()){new a.Notice("Admin only, please login as admin.");return}let t=await new Promise(g=>{new A(this.app,"Toggle group","Group name (e.g. session_07_reveal)",g).open()});if(!t)return;let s=t.trim(),n=await this.loadUsers(),r=await new Promise(g=>{new P(this.app,n.filter(_=>_.name!=="Admin"),g).open()});if(!r)return;let i=n.findIndex(g=>g.name===r.name);if(i<0)return;let u=n[i];if(!u)return;let l=new Set(((h=u.groups)!=null?h:[]).map(String));u.groups=Array.from(l),this.state.currentCharacter===u.name&&this.state.isAuthenticated&&(this.state.currentGroups=(f=u.groups)!=null?f:[]),await this.saveUsers(n),this.state.currentCharacter===u.name&&this.state.isAuthenticated&&(this.state.currentGroups=(w=u.groups)!=null?w:[],await this.saveData(this.state),this.renderStatus()),this.refreshAllMarkdownViews();let p=((y=(m=u.groups)==null?void 0:m.includes(s))!=null?y:!1)?"added":"removed";new a.Notice(`\u2705 ${p.toUpperCase()}: "${s}" ${p==="added"?"to":"from"} ${r.name}`)}}),this.addCommand({id:"authentificator-admin-toggle-group-all",name:"Admin: toggle group for all players",callback:async()=>{var l;if(!this.isAdmin()){new a.Notice("Admin only, please login as admin.");return}let t=await new Promise(d=>{new A(this.app,"Toggle group for ALL","Group name (e.g. session_07_reveal)",d).open()});if(!t)return;let s=t.trim(),n=await this.loadUsers(),r=n.filter(d=>d.name!=="Admin"),u=r.filter(d=>{var p;return((p=d.groups)!=null?p:[]).includes(s)}).length<Math.ceil(r.length/2);for(let d of r){let p=new Set(((l=d.groups)!=null?l:[]).map(String));u?p.add(s):p.delete(s),d.groups=Array.from(p)}await this.saveUsers(n),this.refreshAllMarkdownViews(),new a.Notice(`\u2705 ${u?"Added":"Removed"} "${s}" ${u?"to":"from"} ALL players`)}}),this.addCommand({id:"authentificator-admin-reset-temp-groups",name:"Admin: reset temporary groups",callback:async()=>{var r;if(!this.isAdmin()){new a.Notice("Admin only, please login as admin.");return}let t=await new Promise(i=>{new A(this.app,"Reset temporary groups","Prefix (default: session_)",i).open()}),s=t&&t.trim().length>0?t.trim():"session_",n=await this.loadUsers();for(let i of n)i.name!=="Admin"&&(i.groups=((r=i.groups)!=null?r:[]).filter(u=>!String(u).startsWith(s)));await this.saveUsers(n),this.refreshAllMarkdownViews(),new a.Notice(`Removed all groups starting with "${s}" from all players`)}}),this.addCommand({id:"authentificator-admin-who-has-group",name:"Admin: who has group?",callback:async()=>{if(!this.isAdmin()){new a.Notice("Admin only, please login as admin.");return}let t=await new Promise(i=>{new A(this.app,"Who has group?","Group name (e.g. party)",i).open()});if(!t)return;let s=t.trim(),r=(await this.loadUsers()).filter(i=>i.name!=="Admin").filter(i=>{var u;return((u=i.groups)!=null?u:[]).includes(s)}).map(i=>i.name);new a.Notice(r.length?`\u2705 "${s}" holders: ${r.join(", ")}`:`\u2139\uFE0F Nobody has "${s}"`)}}),this.registerMarkdownCodeBlockProcessor("dndgate",async(t,s,n)=>{var f;let r=V(t),i=new a.Component;if(this.register(()=>i.unload()),this.isAdmin()){await a.MarkdownRenderer.render(this.app,r.body.trim(),s,n.sourcePath,i);return}let u=this.state.isAuthenticated,l=r.requireAuth?u:!0,d=r.groups,p=(f=this.state.currentGroups)!=null?f:[],h=d.length>0&&d.some(w=>p.includes(w));if(!l||!h){s.createEl("div",{text:"Access denied. \u{1F512}"});return}await a.MarkdownRenderer.render(this.app,r.body.trim(),s,n.sourcePath,i)}),this.registerMarkdownPostProcessor((t,s)=>{var y;if(this.isAdmin())return;let n=this.app.vault.getAbstractFileByPath(s.sourcePath);if(!(n instanceof a.TFile))return;let r=this.app.metadataCache.getFileCache(n),i=r==null?void 0:r.frontmatter;if(!i)return;let u=i.dnd_access_groups,l=Array.isArray(u)?u.map(g=>String(g)):[];if(l.length===0)return;let d=typeof i.dnd_require_auth=="boolean"?i.dnd_require_auth:!0,p=this.state.isAuthenticated,h=d?p:!0,f=(y=this.state.currentGroups)!=null?y:[],w=l.some(g=>f.includes(g));if(h&&w)return;t.empty();let m=t.createDiv({cls:"authentificator-denied"});if(m.createEl("h3",{text:"Access denied"}),!this.state.currentCharacter){m.createEl("p",{text:"No character selected."}),E(m,"Select character",()=>{this.execCommand("account-manager:authentificator-select-character")});return}this.state.isAuthenticated||(m.createEl("p",{text:"You must login to access this content."}),E(m,"Login",()=>{this.execCommand("account-manager:authentificator-login")})),E(m,"Open gated note\u2026",()=>{this.execCommand("account-manager:authentificator-open-gated-note")})})}onunload(){}renderStatus(){var n,r;if(!this.statusEl)return;let e=(n=this.state.currentCharacter)!=null?n:"none",t=this.state.isAuthenticated?"unlocked":"locked",s=this.isAdmin()?"ADMIN":(r=this.state.currentGroups)!=null&&r.length?this.state.currentGroups.join(","):"-";this.statusEl.setText(`authentificator: ${e} (${t}) [${s}]`)}execCommand(e){this.app.commands.executeCommandById(e)}isAdmin(){return this.state.currentCharacter==="Admin"&&this.state.isAuthenticated}refreshAllMarkdownViews(){let e=this.app.workspace.getLeavesOfType("markdown");for(let t of e){let s=t.view;if(!(s instanceof a.MarkdownView))continue;let n=s.file;n instanceof a.TFile&&t.openFile(n,{active:!1})}}async ensureFolder(e){this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e).catch(()=>{})}async upsertFile(e,t){let s=this.app.vault.getAbstractFileByPath(e);if(s instanceof a.TFile){await this.app.vault.modify(s,t);return}if(s)throw new Error(`Cannot write file because a folder exists at: ${e}`);let n=e.lastIndexOf("/");if(n>0){let r=e.substring(0,n);await this.ensureFolder(r)}await this.app.vault.create(e,t)}async ensureUsersFile(){let e=this.app.vault.getAbstractFileByPath(v);if(!e){let n={users:[{name:"Admin",salt:"initAdminSalt",hash:"6fADYzT98VWr970cJ2rD/sEmthlRK9Xq71YHrXYZMZM=",groups:["admin","dm"]}]};return await this.upsertFile(v,JSON.stringify(n,null,2)),n}if(!(e instanceof a.TFile))throw new Error(`Users path exists but is not a file: ${v}`);let t=await this.app.vault.read(e),s=JSON.parse(t);if(!q(s))throw new Error(`Invalid users.json format at ${v}`);return s}async loadUsers(){var t;return(t=(await this.ensureUsersFile()).users)!=null?t:[]}async saveUsers(e){let t=JSON.stringify({users:e},null,2);await this.upsertFile(v,t)}async generateUserReportNote(){var n;let e="Admin Area/UserReport.md",t=await this.loadUsers(),s=[];s.push("---"),s.push("dnd_access_groups: [admin]"),s.push("dnd_require_auth: true"),s.push("generated: true"),s.push("---"),s.push(""),s.push("# User Report"),s.push(""),s.push(`Updated: ${new Date().toISOString()}`),s.push(""),s.push("| User | Groups |"),s.push("|---|---|");for(let r of t)s.push(`| ${r.name} | ${((n=r.groups)!=null?n:[]).join(", ")||"-"} |`);return s.push(""),await this.upsertFile(e,s.join(`
`)),e}async verifyPassword(e,t){let n=(await this.loadUsers()).find(i=>i.name===e);return n?await F(`${n.salt}:${t}`)===n.hash:!1}canAccessFile(e){var l;if(this.isAdmin())return!0;let t=this.app.metadataCache.getFileCache(e),s=t==null?void 0:t.frontmatter;if(!s)return!1;let n=s.dnd_access_groups,r=Array.isArray(n)?n.map(d=>String(d)):[];if(r.length===0||(typeof s.dnd_require_auth=="boolean"?s.dnd_require_auth:!0)&&!this.state.isAuthenticated)return!1;let u=(l=this.state.currentGroups)!=null?l:[];return r.some(d=>u.includes(d))}},b=class extends a.Modal{constructor(e,t,s){super(e);this.users=t;this.done=s}onOpen(){let{contentEl:e}=this;if(e.empty(),e.createEl("h3",{text:"Select character"}),!this.users.length)e.createEl("p",{text:"No users found."});else for(let s of this.users){let n=e.createEl("button",{text:s.name});n.addClass("am-modal-btn"),n.addEventListener("click",()=>{this.done(s),this.close()})}let t=e.createEl("button",{text:"Cancel"});t.addClass("am-modal-cancel"),t.addEventListener("click",()=>{this.done(null),this.close()})}onClose(){this.contentEl.empty()}},B=class extends a.Modal{constructor(e,t){super(e);this.done=t;this.value=""}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h3",{text:"Enter password"});let t=e.createEl("input",{type:"password"});t.focus(),t.addEventListener("input",()=>this.value=t.value),new a.Setting(e).addButton(s=>s.setButtonText("OK").setCta().onClick(()=>{this.done(this.value),this.close()})).addButton(s=>s.setButtonText("Cancel").onClick(()=>{this.done(null),this.close()}))}onClose(){this.contentEl.empty()}},U=class extends a.Modal{constructor(e,t){super(e);this.done=t;this.name="";this.password="";this.groups=""}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h3",{text:"Create / update user"});let t=e.createEl("input",{type:"text",placeholder:"User name (e.g. Castro)"});t.addEventListener("input",()=>this.name=t.value),t.focus();let s=e.createEl("input",{type:"password",placeholder:"Password"});s.addEventListener("input",()=>this.password=s.value);let n=e.createEl("input",{type:"text",placeholder:"Groups (comma separated), e.g. party, house_cannith"});n.addEventListener("input",()=>this.groups=n.value),new a.Setting(e).addButton(r=>r.setButtonText("Save").setCta().onClick(()=>{this.done({name:this.name,password:this.password,groups:this.groups}),this.close()})).addButton(r=>r.setButtonText("Cancel").onClick(()=>{this.done(null),this.close()}))}onClose(){this.contentEl.empty()}},A=class extends a.Modal{constructor(e,t,s,n){super(e);this.title=t;this.placeholder=s;this.done=n;this.value=""}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h3",{text:this.title});let t=e.createEl("input",{type:"text",placeholder:this.placeholder});t.addEventListener("input",()=>this.value=t.value),t.focus(),new a.Setting(e).addButton(s=>s.setButtonText("OK").setCta().onClick(()=>{this.done(this.value.trim()||null),this.close()})).addButton(s=>s.setButtonText("Cancel").onClick(()=>{this.done(null),this.close()}))}onClose(){this.contentEl.empty()}},P=class extends a.FuzzySuggestModal{constructor(e,t,s){super(e);this.users=t;this.done=s;this.hasResolved=!1;this.setPlaceholder("Pick a user\u2026")}getItems(){return this.users}getItemText(e){return e.name}onChooseItem(e){this.hasResolved||(this.hasResolved=!0,this.done(e),this.close())}onClose(){super.onClose(),!this.hasResolved&&(this.hasResolved=!0,this.done(null))}},S=class extends a.FuzzySuggestModal{constructor(e,t){super(e);this.plugin=t;this.setPlaceholder("Type to search gated notes.")}getItems(){return this.plugin.app.vault.getMarkdownFiles().filter(t=>this.plugin.canAccessFile(t))}getItemText(e){return e.path}onChooseItem(e){this.handleChoose(e)}async handleChoose(e){await this.plugin.app.workspace.getLeaf(!0).openFile(e)}},T=class extends a.Modal{constructor(e,t){super(e);this.plugin=t}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h3",{text:"Authentificator"}),new a.Setting(e).setName("Select character").addButton(t=>t.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-select-character")})),new a.Setting(e).setName("Login (password)").addButton(t=>t.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-login")})),new a.Setting(e).setName("Open gated note\u2026").addButton(t=>t.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-open-gated-note")})),new a.Setting(e).setName("Logout").addButton(t=>t.setButtonText("Do it").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-logout")})),this.plugin.isAdmin()&&(e.createEl("hr"),new a.Setting(e).setName("Admin: create or update user").addButton(t=>t.setButtonText("Open").onClick(()=>{this.close(),this.plugin.execCommand("account-manager:authentificator-admin-create-update-user")})),new a.Setting(e).setName("Admin: toggle group for user").addButton(t=>t.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-admin-toggle-group")})),new a.Setting(e).setName("Admin: toggle group for all players").addButton(t=>t.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-admin-toggle-group-all")})),new a.Setting(e).setName("Admin: reset temporary groups").addButton(t=>t.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-admin-reset-temp-groups")})),new a.Setting(e).setName("Admin: who has group?").addButton(t=>t.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-admin-who-has-group")})))}onClose(){this.contentEl.empty()}};
