/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var C=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var D=(c,d)=>{for(var t in d)C(c,t,{get:d[t],enumerable:!0})},G=(c,d,t,e)=>{if(d&&typeof d=="object"||typeof d=="function")for(let s of $(d))!I.call(c,s)&&s!==t&&C(c,s,{get:()=>d[s],enumerable:!(e=O(d,s))||e.enumerable});return c};var M=c=>G(C({},"__esModule",{value:!0}),c);var q={};D(q,{default:()=>y});module.exports=M(q);var r=require("obsidian"),v=require("crypto"),b=require("obsidian"),x="DnDAuth/users.json",E={currentCharacter:null,isAuthenticated:!1,currentGroups:[]};function F(c){return(0,v.createHash)("sha256").update(c,"utf8").digest("base64")}function R(c=16){return(0,v.randomBytes)(c).toString("base64")}function k(c,d,t){let e=c.createEl("button",{text:d});e.style.marginRight="0.5rem",e.addEventListener("click",t)}function N(c){let d=c.split(`
`),t=[],e=!0,s=0;for(let a=0;a<d.length;a++){let i=d[a];if(i===void 0)continue;let o=i.trim();if(o==="---"){s=a+1;break}if(!o)continue;let u=o.match(/^groups\s*:\s*(.+)$/i);if(u&&u[1]){t=u[1].split(",").map(h=>h.trim()).filter(Boolean);continue}let l=o.match(/^requireAuth\s*:\s*(true|false)$/i);if(l&&l[1]){e=l[1].toLowerCase()==="true";continue}}let n=d.slice(s).join(`
`);return{groups:t,body:n,requireAuth:e}}var y=class extends r.Plugin{constructor(){super(...arguments);this.state={...E};this.statusEl=null}async onload(){this.state={...E,...await this.loadData()},await this.ensureUsersFile(),this.statusEl=this.addStatusBarItem(),this.renderStatus(),this.statusEl&&(this.statusEl.style.cursor="pointer",this.statusEl.addEventListener("click",()=>{new S(this.app,this).open()})),this.registerMarkdownCodeBlockProcessor("dndadmin",async(t,e)=>{var o;if(!this.isAdmin()){e.createEl("div",{text:"\u{1F512} Admin only."});return}let s=e.createDiv(),n=s.createEl("button",{text:"Create / Update user"});n.onclick=()=>{this.execCommand("obsidian_account_manager:authentificator-admin-create-update-user")};let a=s.createEl("button",{text:"Regenerate report"});a.style.marginLeft="0.5rem",a.onclick=async()=>{await this.generateUserReportNote(),this.refreshAllMarkdownViews(),new r.Notice("\u2705 Report updated")},e.createEl("hr");let i=await this.loadUsers();for(let u of i)e.createDiv({text:`${u.name} \u2014 ${((o=u.groups)!=null?o:[]).join(", ")||"-"}`})}),this.addCommand({id:"authentificator-admin-setup-admin-area",name:"Admin: Setup Admin Area",callback:async()=>{if(!this.isAdmin()){new r.Notice("\u{1F6AB} Admin only. Please login as Admin.");return}await this.ensureFolder("Admin Area"),await this.upsertFile("Admin Area/UserManagement.md",["---","dnd_access_groups: [admin]","dnd_require_auth: true","generated: true","---","","# Admin Area \u2013 User Management","","```dndadmin","mode: users","```",""].join(`
`)),await this.generateUserReportNote(),this.refreshAllMarkdownViews();let t=this.app.vault.getAbstractFileByPath("Admin Area/UserManagement.md");t&&await this.app.workspace.getLeaf(!0).openFile(t),new r.Notice("\u2705 Admin Area created/updated.")}}),this.addCommand({id:"authentificator-select-character",name:"Select character",callback:async()=>{let t=await this.loadUsers(),e=await new Promise(s=>{new _(this.app,t,s).open()});e&&(this.state.currentCharacter=e.name,this.state.isAuthenticated=!1,this.state.currentGroups=[],await this.saveData(this.state),this.renderStatus(),this.refreshAllMarkdownViews(),new r.Notice(`Selected character: ${e.name}`))}}),this.addCommand({id:"authentificator-login",name:"Login (password)",callback:async()=>{var i;let t=this.state.currentCharacter;if(!t){new r.Notice("Select a character first.");return}let e=await new Promise(o=>{new B(this.app,o).open()});if(!e)return;if(!await this.verifyPassword(t,e)){this.state.isAuthenticated=!1,this.state.currentGroups=[],await this.saveData(this.state),this.renderStatus(),this.refreshAllMarkdownViews(),new r.Notice("\u274C Login failed.");return}let a=(await this.loadUsers()).find(o=>o.name===t);this.state.isAuthenticated=!0,this.state.currentGroups=((i=a==null?void 0:a.groups)!=null?i:[]).map(String),await this.saveData(this.state),this.renderStatus(),this.refreshAllMarkdownViews(),new r.Notice(`\u2705 Logged in as ${t}`)}}),this.addCommand({id:"authentificator-logout",name:"Logout",callback:async()=>{this.state={...E},await this.saveData(this.state),this.renderStatus(),this.refreshAllMarkdownViews(),new r.Notice("Logged out.")}}),this.addCommand({id:"authentificator-open-gated-note",name:"Open gated note\u2026",callback:async()=>{if(!this.isAdmin()&&!this.state.isAuthenticated){new r.Notice("Please login first.");return}new T(this.app,this).open()}}),this.addCommand({id:"authentificator-admin-create-update-user",name:"Admin: Create/Update user",callback:async()=>{if(!this.isAdmin()){new r.Notice("\u{1F6AB} Admin only. Please login as Admin.");return}let t=await new Promise(p=>{new U(this.app,p).open()});if(!t)return;let e=t.name.trim(),s=t.password;if(!e)return void new r.Notice("User name cannot be empty.");if(!s)return void new r.Notice("Password cannot be empty.");let n=t.groups.split(",").map(p=>p.trim()).filter(Boolean);e==="Admin"&&!n.includes("admin")&&n.push("admin");let a=await this.loadUsers(),i=R(),o=F(`${i}:${s}`),u=a.findIndex(p=>p.name===e),l={name:e,salt:i,hash:o,groups:n},h;u>=0?h=l:a.push(l),await this.saveUsers(a),this.refreshAllMarkdownViews(),new r.Notice(`\u2705 Saved user: ${e}`)}}),this.addCommand({id:"authentificator-admin-toggle-group",name:"Admin: Toggle group for user",callback:async()=>{var h,p,m,f,A;if(!this.isAdmin()){new r.Notice("\u{1F6AB} Admin only. Please login as Admin.");return}let t=await new Promise(w=>{new g(this.app,"Toggle group","Group name (e.g. session_07_reveal)",w).open()});if(!t)return;let e=t.trim(),s=await this.loadUsers(),n=await new Promise(w=>{new P(this.app,s.filter(L=>L.name!=="Admin"),w).open()});if(!n)return;let a=s.findIndex(w=>w.name===n.name);if(a<0)return;let i=s[a];if(!i)return;let o=new Set(((h=i.groups)!=null?h:[]).map(String));i.groups=Array.from(o),this.state.currentCharacter===i.name&&this.state.isAuthenticated&&(this.state.currentGroups=(p=i.groups)!=null?p:[]),await this.saveUsers(s),this.state.currentCharacter===i.name&&this.state.isAuthenticated&&(this.state.currentGroups=(m=i.groups)!=null?m:[],await this.saveData(this.state),this.renderStatus()),this.refreshAllMarkdownViews();let l=((A=(f=i.groups)==null?void 0:f.includes(e))!=null?A:!1)?"added":"removed";new r.Notice(`\u2705 ${l.toUpperCase()}: "${e}" ${l==="added"?"to":"from"} ${n.name}`)}}),this.addCommand({id:"authentificator-admin-toggle-group-all",name:"Admin: Toggle group for ALL players",callback:async()=>{var o;if(!this.isAdmin()){new r.Notice("\u{1F6AB} Admin only. Please login as Admin.");return}let t=await new Promise(u=>{new g(this.app,"Toggle group for ALL","Group name (e.g. session_07_reveal)",u).open()});if(!t)return;let e=t.trim(),s=await this.loadUsers(),n=s.filter(u=>u.name!=="Admin"),i=n.filter(u=>{var l;return((l=u.groups)!=null?l:[]).includes(e)}).length<Math.ceil(n.length/2);for(let u of n){let l=new Set(((o=u.groups)!=null?o:[]).map(String));i?l.add(e):l.delete(e),u.groups=Array.from(l)}await this.saveUsers(s),this.refreshAllMarkdownViews(),new r.Notice(`\u2705 ${i?"Added":"Removed"} "${e}" ${i?"to":"from"} ALL players`)}}),this.addCommand({id:"authentificator-admin-reset-temp-groups",name:"Admin: Reset temporary groups",callback:async()=>{var n;if(!this.isAdmin()){new r.Notice("\u{1F6AB} Admin only. Please login as Admin.");return}let t=await new Promise(a=>{new g(this.app,"Reset temporary groups","Prefix (default: session_)",a).open()}),e=t&&t.trim().length>0?t.trim():"session_",s=await this.loadUsers();for(let a of s)a.name!=="Admin"&&(a.groups=((n=a.groups)!=null?n:[]).filter(i=>!String(i).startsWith(e)));await this.saveUsers(s),this.refreshAllMarkdownViews(),new r.Notice(`\u2705 Removed all groups starting with "${e}" from all players`)}}),this.addCommand({id:"authentificator-admin-who-has-group",name:"Admin: Who has group?",callback:async()=>{if(!this.isAdmin()){new r.Notice("\u{1F6AB} Admin only. Please login as Admin.");return}let t=await new Promise(a=>{new g(this.app,"Who has group?","Group name (e.g. party)",a).open()});if(!t)return;let e=t.trim(),n=(await this.loadUsers()).filter(a=>a.name!=="Admin").filter(a=>{var i;return((i=a.groups)!=null?i:[]).includes(e)}).map(a=>a.name);new r.Notice(n.length?`\u2705 "${e}" holders: ${n.join(", ")}`:`\u2139\uFE0F Nobody has "${e}"`)}}),this.registerMarkdownCodeBlockProcessor("dndgate",async(t,e,s)=>{var h;let n=N(t);if(this.isAdmin()){await b.MarkdownRenderer.renderMarkdown(n.body.trim(),e,s.sourcePath,this);return}let a=this.state.isAuthenticated,i=n.requireAuth?a:!0,o=n.groups,u=(h=this.state.currentGroups)!=null?h:[],l=o.length>0&&o.some(p=>u.includes(p));if(!i||!l){e.createEl("div",{text:"\u{1F512} Access denied."});return}await b.MarkdownRenderer.renderMarkdown(n.body.trim(),e,s.sourcePath,this)}),this.registerMarkdownPostProcessor((t,e)=>{var f;if(this.isAdmin())return;let s=this.app.vault.getAbstractFileByPath(e.sourcePath);if(!s)return;let n=this.app.metadataCache.getFileCache(s),a=n==null?void 0:n.frontmatter;if(!a)return;let i=Array.isArray(a.dnd_access_groups)?a.dnd_access_groups:[];if(i.length===0)return;let o=typeof a.dnd_require_auth=="boolean"?a.dnd_require_auth:!0,u=this.state.isAuthenticated,l=o?u:!0,h=(f=this.state.currentGroups)!=null?f:[],p=i.some(A=>h.includes(A));if(l&&p)return;t.empty();let m=t.createDiv({cls:"authentificator-denied"});if(m.createEl("h3",{text:"\u{1F512} Access denied"}),!this.state.currentCharacter){m.createEl("p",{text:"No character selected."}),k(m,"Select character",()=>{this.execCommand("obsidian_account_manager:authentificator-select-character")});return}this.state.isAuthenticated||(m.createEl("p",{text:"You must login to access this content."}),k(m,"Login",()=>{this.execCommand("obsidian_account_manager:authentificator-login")})),k(m,"Open gated note\u2026",()=>{this.execCommand("obsidian_account_manager:authentificator-open-gated-note")})})}onunload(){}renderStatus(){var n,a;if(!this.statusEl)return;let t=(n=this.state.currentCharacter)!=null?n:"none",e=this.state.isAuthenticated?"unlocked":"locked",s=this.isAdmin()?"ADMIN":(a=this.state.currentGroups)!=null&&a.length?this.state.currentGroups.join(","):"-";this.statusEl.setText(`authentificator: ${t} (${e}) [${s}]`)}execCommand(t){var e,s;(s=(e=this.app.commands)==null?void 0:e.executeCommandById)==null||s.call(e,t)}isAdmin(){return this.state.currentCharacter==="Admin"&&this.state.isAuthenticated}refreshAllMarkdownViews(){this.app.workspace.iterateAllLeaves(t=>{var s,n,a,i,o,u;let e=t.view;if(e&&((s=e.getViewType)==null?void 0:s.call(e))==="markdown"){(a=(n=e.previewMode)==null?void 0:n.rerender)==null||a.call(n,!0),(o=(i=e.currentMode)==null?void 0:i.rerender)==null||o.call(i,!0),(u=e.render)==null||u.call(e);let l=e.file;l&&t.openFile(l,{active:!1,state:t.getViewState().state}).catch(()=>{})}})}async ensureFolder(t){this.app.vault.getAbstractFileByPath(t)||await this.app.vault.createFolder(t).catch(()=>{})}async upsertFile(t,e){let s=this.app.vault.getAbstractFileByPath(t);if(s){await this.app.vault.modify(s,e);return}let n=t.lastIndexOf("/");if(n>0){let a=t.substring(0,n);await this.ensureFolder(a)}await this.app.vault.create(t,e).catch(()=>{})}async ensureUsersFile(){let t=this.app.vault.getAbstractFileByPath(x);if(!t){let s={users:[{name:"Admin",salt:"initAdminSalt",hash:"6fADYzT98VWr970cJ2rD/sEmthlRK9Xq71YHrXYZMZM=",groups:["admin","dm"]}]};return await this.upsertFile(x,JSON.stringify(s,null,2)),s}let e=await this.app.vault.read(t);return JSON.parse(e)}async loadUsers(){var e;return(e=(await this.ensureUsersFile()).users)!=null?e:[]}async saveUsers(t){let e=JSON.stringify({users:t},null,2);await this.upsertFile(x,e)}async generateUserReportNote(){var n;let t="Admin Area/UserReport.md",e=await this.loadUsers(),s=[];s.push("---"),s.push("dnd_access_groups: [admin]"),s.push("dnd_require_auth: true"),s.push("generated: true"),s.push("---"),s.push(""),s.push("# User Report"),s.push(""),s.push(`Updated: ${new Date().toISOString()}`),s.push(""),s.push("| User | Groups |"),s.push("|---|---|");for(let a of e)s.push(`| ${a.name} | ${((n=a.groups)!=null?n:[]).join(", ")||"-"} |`);return s.push(""),await this.upsertFile(t,s.join(`
`)),t}async verifyPassword(t,e){let n=(await this.loadUsers()).find(i=>i.name===t);return n?F(`${n.salt}:${e}`)===n.hash:!1}canAccessFile(t){var o;if(this.isAdmin())return!0;let e=this.app.metadataCache.getFileCache(t),s=e==null?void 0:e.frontmatter;if(!s)return!1;let n=Array.isArray(s.dnd_access_groups)?s.dnd_access_groups:[];if(n.length===0||(typeof s.dnd_require_auth=="boolean"?s.dnd_require_auth:!0)&&!this.state.isAuthenticated)return!1;let i=(o=this.state.currentGroups)!=null?o:[];return n.some(u=>i.includes(u))}},_=class extends r.Modal{constructor(t,e,s){super(t);this.users=e;this.done=s}onOpen(){let{contentEl:t}=this;if(t.empty(),t.createEl("h3",{text:"Select character"}),!this.users.length)t.createEl("p",{text:"No users found."});else for(let s of this.users){let n=t.createEl("button",{text:s.name});n.style.display="block",n.style.width="100%",n.style.margin="0.4rem 0",n.addEventListener("click",()=>{this.done(s),this.close()})}let e=t.createEl("button",{text:"Cancel"});e.style.marginTop="0.8rem",e.addEventListener("click",()=>{this.done(null),this.close()})}onClose(){this.contentEl.empty()}},B=class extends r.Modal{constructor(t,e){super(t);this.done=e;this.value=""}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:"Enter password"});let e=t.createEl("input",{type:"password"});e.focus(),e.addEventListener("input",()=>this.value=e.value),new r.Setting(t).addButton(s=>s.setButtonText("OK").setCta().onClick(()=>{this.done(this.value),this.close()})).addButton(s=>s.setButtonText("Cancel").onClick(()=>{this.done(null),this.close()}))}onClose(){this.contentEl.empty()}},U=class extends r.Modal{constructor(t,e){super(t);this.done=e;this.name="";this.password="";this.groups=""}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:"Create / Update user"});let e=t.createEl("input",{type:"text",placeholder:"User name (e.g. Castro)"});e.addEventListener("input",()=>this.name=e.value),e.focus();let s=t.createEl("input",{type:"password",placeholder:"Password"});s.addEventListener("input",()=>this.password=s.value);let n=t.createEl("input",{type:"text",placeholder:"Groups (comma separated), e.g. party, house_cannith"});n.addEventListener("input",()=>this.groups=n.value),new r.Setting(t).addButton(a=>a.setButtonText("Save").setCta().onClick(()=>{this.done({name:this.name,password:this.password,groups:this.groups}),this.close()})).addButton(a=>a.setButtonText("Cancel").onClick(()=>{this.done(null),this.close()}))}onClose(){this.contentEl.empty()}},g=class extends r.Modal{constructor(t,e,s,n){super(t);this.title=e;this.placeholder=s;this.done=n;this.value=""}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:this.title});let e=t.createEl("input",{type:"text",placeholder:this.placeholder});e.addEventListener("input",()=>this.value=e.value),e.focus(),new r.Setting(t).addButton(s=>s.setButtonText("OK").setCta().onClick(()=>{this.done(this.value.trim()||null),this.close()})).addButton(s=>s.setButtonText("Cancel").onClick(()=>{this.done(null),this.close()}))}onClose(){this.contentEl.empty()}},P=class extends r.FuzzySuggestModal{constructor(t,e,s){super(t);this.users=e;this.done=s;this.hasResolved=!1;this.setPlaceholder("Pick a user\u2026")}getItems(){return this.users}getItemText(t){return t.name}onChooseItem(t){this.hasResolved||(this.hasResolved=!0,this.done(t),this.close())}onClose(){super.onClose(),!this.hasResolved&&(this.hasResolved=!0,this.done(null))}},T=class extends r.FuzzySuggestModal{constructor(t,e){super(t);this.plugin=e;this.setPlaceholder("Type to search gated notes\u2026")}getItems(){return this.plugin.app.vault.getMarkdownFiles().filter(e=>this.plugin.canAccessFile(e))}getItemText(t){return t.path}async onChooseItem(t){await this.plugin.app.workspace.getLeaf(!0).openFile(t)}},S=class extends r.Modal{constructor(t,e){super(t);this.plugin=e}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:"authentificator"}),new r.Setting(t).setName("Select character").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("obsidian_account_manager:authentificator-select-character")})),new r.Setting(t).setName("Login (password)").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("obsidian_account_manager:authentificator-login")})),new r.Setting(t).setName("Open gated note\u2026").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("obsidian_account_manager:authentificator-open-gated-note")})),new r.Setting(t).setName("Logout").addButton(e=>e.setButtonText("Do it").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("obsidian_account_manager:authentificator-logout")})),this.plugin.isAdmin()&&(t.createEl("hr"),new r.Setting(t).setName("Admin: Create/Update user").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("obsidian_account_manager:authentificator-admin-create-update-user")})),new r.Setting(t).setName("Admin: Toggle group for user").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("obsidian_account_manager:authentificator-admin-toggle-group")})),new r.Setting(t).setName("Admin: Toggle group for ALL players").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("obsidian_account_manager:authentificator-admin-toggle-group-all")})),new r.Setting(t).setName("Admin: Reset temporary groups").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("obsidian_account_manager:authentificator-admin-reset-temp-groups")})),new r.Setting(t).setName("Admin: Who has group?").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("obsidian_account_manager:authentificator-admin-who-has-group")})))}onClose(){this.contentEl.empty()}};
