/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var v=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var L=(d,o)=>{for(var t in o)v(d,t,{get:o[t],enumerable:!0})},D=(d,o,t,e)=>{if(o&&typeof o=="object"||typeof o=="function")for(let s of $(o))!I.call(d,s)&&s!==t&&v(d,s,{get:()=>o[s],enumerable:!(e=O(o,s))||e.enumerable});return d};var G=d=>D(v({},"__esModule",{value:!0}),d);var N={};L(N,{default:()=>y});module.exports=G(N);var r=require("obsidian"),C="DnDAuth/users.json",x={currentCharacter:null,isAuthenticated:!1,currentGroups:[]};function _(d){let o="";for(let t of d)o+=String.fromCharCode(t);return btoa(o)}async function S(d){let o=new TextEncoder().encode(d),t=await crypto.subtle.digest("SHA-256",o);return _(new Uint8Array(t))}function M(d=16){let o=new Uint8Array(d);return crypto.getRandomValues(o),_(o)}function E(d,o,t){let e=d.createEl("button",{text:o});e.addClass("am-action-btn"),e.addEventListener("click",t)}function R(d){let o=d.split(`
`),t=[],e=!0,s=0;for(let a=0;a<o.length;a++){let i=o[a];if(i===void 0)continue;let u=i.trim();if(u==="---"){s=a+1;break}if(!u)continue;let c=u.match(/^groups\s*:\s*(.+)$/i);if(c&&c[1]){t=c[1].split(",").map(h=>h.trim()).filter(Boolean);continue}let l=u.match(/^requireAuth\s*:\s*(true|false)$/i);if(l&&l[1]){e=l[1].toLowerCase()==="true";continue}}let n=o.slice(s).join(`
`);return{groups:t,body:n,requireAuth:e}}var y=class extends r.Plugin{constructor(){super(...arguments);this.state={...x};this.statusEl=null}async onload(){this.state={...x,...await this.loadData()},await this.ensureUsersFile(),this.statusEl=this.addStatusBarItem(),this.renderStatus(),this.statusEl&&(this.statusEl.addClass("am-status-clickable"),this.statusEl.addEventListener("click",()=>{new T(this.app,this).open()})),this.registerMarkdownCodeBlockProcessor("dndadmin",async(t,e)=>{var u;if(!this.isAdmin()){e.createEl("div",{text:"Admin only. \u{1F512}"});return}let s=e.createDiv(),n=s.createEl("button",{text:"Create / update user"});n.onclick=()=>{this.execCommand("account-manager:authentificator-admin-create-update-user")};let a=s.createEl("button",{text:"Regenerate report"});a.addClass("am-report-btn"),a.onclick=async()=>{await this.generateUserReportNote(),this.refreshAllMarkdownViews(),new r.Notice("Report updated")},e.createEl("hr");let i=await this.loadUsers();for(let c of i)e.createDiv({text:`${c.name} \u2014 ${((u=c.groups)!=null?u:[]).join(", ")||"-"}`})}),this.addCommand({id:"authentificator-admin-setup-admin-area",name:"Admin: setup admin area",callback:async()=>{if(!this.isAdmin()){new r.Notice("Admin only, please login as admin.");return}await this.ensureFolder("Admin Area"),await this.upsertFile("Admin Area/UserManagement.md",["---","dnd_access_groups: [admin]","dnd_require_auth: true","generated: true","---","","# Admin Area \u2013 User Management","","```dndadmin","mode: users","```",""].join(`
`)),await this.generateUserReportNote(),this.refreshAllMarkdownViews();let t=this.app.vault.getAbstractFileByPath("Admin Area/UserManagement.md");t&&await this.app.workspace.getLeaf(!0).openFile(t),new r.Notice("Admin area created/updated.")}}),this.addCommand({id:"authentificator-select-character",name:"Select character",callback:async()=>{let t=await this.loadUsers(),e=await new Promise(s=>{new k(this.app,t,s).open()});e&&(this.state.currentCharacter=e.name,this.state.isAuthenticated=!1,this.state.currentGroups=[],await this.saveData(this.state),this.renderStatus(),this.refreshAllMarkdownViews(),new r.Notice(`Selected character: ${e.name}`))}}),this.addCommand({id:"authentificator-login",name:"Login (password)",callback:async()=>{var i;let t=this.state.currentCharacter;if(!t){new r.Notice("Select a character first.");return}let e=await new Promise(u=>{new b(this.app,u).open()});if(!e)return;if(!await this.verifyPassword(t,e)){this.state.isAuthenticated=!1,this.state.currentGroups=[],await this.saveData(this.state),this.renderStatus(),this.refreshAllMarkdownViews(),new r.Notice("Login failed.");return}let a=(await this.loadUsers()).find(u=>u.name===t);this.state.isAuthenticated=!0,this.state.currentGroups=((i=a==null?void 0:a.groups)!=null?i:[]).map(String),await this.saveData(this.state),this.renderStatus(),this.refreshAllMarkdownViews(),new r.Notice(`Logged in as ${t}`)}}),this.addCommand({id:"authentificator-logout",name:"Logout",callback:async()=>{this.state={...x},await this.saveData(this.state),this.renderStatus(),this.refreshAllMarkdownViews(),new r.Notice("Logged out.")}}),this.addCommand({id:"authentificator-open-gated-note",name:"Open gated note\u2026",callback:async()=>{if(!this.isAdmin()&&!this.state.isAuthenticated){new r.Notice("Please login first.");return}new P(this.app,this).open()}}),this.addCommand({id:"authentificator-admin-create-update-user",name:"Admin: create/update user",callback:async()=>{if(!this.isAdmin()){new r.Notice("Admin only, please login as admin.");return}let t=await new Promise(p=>{new B(this.app,p).open()});if(!t)return;let e=t.name.trim(),s=t.password;if(!e)return void new r.Notice("User name cannot be empty.");if(!s)return void new r.Notice("Password cannot be empty.");let n=t.groups.split(",").map(p=>p.trim()).filter(Boolean);e==="Admin"&&!n.includes("admin")&&n.push("admin");let a=await this.loadUsers(),i=M(),u=await S(`${i}:${s}`),c=a.findIndex(p=>p.name===e),l={name:e,salt:i,hash:u,groups:n},h;c>=0?h=l:a.push(l),await this.saveUsers(a),this.refreshAllMarkdownViews(),new r.Notice(`\u2705 Saved user: ${e}`)}}),this.addCommand({id:"authentificator-admin-toggle-group",name:"Admin: toggle group for user",callback:async()=>{var h,p,m,f,A;if(!this.isAdmin()){new r.Notice("Admin only, please login as admin.");return}let t=await new Promise(w=>{new g(this.app,"Toggle group","Group name (e.g. session_07_reveal)",w).open()});if(!t)return;let e=t.trim(),s=await this.loadUsers(),n=await new Promise(w=>{new U(this.app,s.filter(F=>F.name!=="Admin"),w).open()});if(!n)return;let a=s.findIndex(w=>w.name===n.name);if(a<0)return;let i=s[a];if(!i)return;let u=new Set(((h=i.groups)!=null?h:[]).map(String));i.groups=Array.from(u),this.state.currentCharacter===i.name&&this.state.isAuthenticated&&(this.state.currentGroups=(p=i.groups)!=null?p:[]),await this.saveUsers(s),this.state.currentCharacter===i.name&&this.state.isAuthenticated&&(this.state.currentGroups=(m=i.groups)!=null?m:[],await this.saveData(this.state),this.renderStatus()),this.refreshAllMarkdownViews();let l=((A=(f=i.groups)==null?void 0:f.includes(e))!=null?A:!1)?"added":"removed";new r.Notice(`\u2705 ${l.toUpperCase()}: "${e}" ${l==="added"?"to":"from"} ${n.name}`)}}),this.addCommand({id:"authentificator-admin-toggle-group-all",name:"Admin: toggle group for all players",callback:async()=>{var u;if(!this.isAdmin()){new r.Notice("Admin only, please login as admin.");return}let t=await new Promise(c=>{new g(this.app,"Toggle group for ALL","Group name (e.g. session_07_reveal)",c).open()});if(!t)return;let e=t.trim(),s=await this.loadUsers(),n=s.filter(c=>c.name!=="Admin"),i=n.filter(c=>{var l;return((l=c.groups)!=null?l:[]).includes(e)}).length<Math.ceil(n.length/2);for(let c of n){let l=new Set(((u=c.groups)!=null?u:[]).map(String));i?l.add(e):l.delete(e),c.groups=Array.from(l)}await this.saveUsers(s),this.refreshAllMarkdownViews(),new r.Notice(`\u2705 ${i?"Added":"Removed"} "${e}" ${i?"to":"from"} ALL players`)}}),this.addCommand({id:"authentificator-admin-reset-temp-groups",name:"Admin: reset temporary groups",callback:async()=>{var n;if(!this.isAdmin()){new r.Notice("Admin only, please login as admin.");return}let t=await new Promise(a=>{new g(this.app,"Reset temporary groups","Prefix (default: session_)",a).open()}),e=t&&t.trim().length>0?t.trim():"session_",s=await this.loadUsers();for(let a of s)a.name!=="Admin"&&(a.groups=((n=a.groups)!=null?n:[]).filter(i=>!String(i).startsWith(e)));await this.saveUsers(s),this.refreshAllMarkdownViews(),new r.Notice(`Removed all groups starting with "${e}" from all players`)}}),this.addCommand({id:"authentificator-admin-who-has-group",name:"Admin: who has group?",callback:async()=>{if(!this.isAdmin()){new r.Notice("Admin only, please login as admin.");return}let t=await new Promise(a=>{new g(this.app,"Who has group?","Group name (e.g. party)",a).open()});if(!t)return;let e=t.trim(),n=(await this.loadUsers()).filter(a=>a.name!=="Admin").filter(a=>{var i;return((i=a.groups)!=null?i:[]).includes(e)}).map(a=>a.name);new r.Notice(n.length?`\u2705 "${e}" holders: ${n.join(", ")}`:`\u2139\uFE0F Nobody has "${e}"`)}}),this.registerMarkdownCodeBlockProcessor("dndgate",async(t,e,s)=>{var h;let n=R(t);if(this.isAdmin()){await r.MarkdownRenderer.render(this.app,n.body.trim(),e,s.sourcePath,this);return}let a=this.state.isAuthenticated,i=n.requireAuth?a:!0,u=n.groups,c=(h=this.state.currentGroups)!=null?h:[],l=u.length>0&&u.some(p=>c.includes(p));if(!i||!l){e.createEl("div",{text:"Access denied. \u{1F512}"});return}await r.MarkdownRenderer.render(this.app,n.body.trim(),e,s.sourcePath,this)}),this.registerMarkdownPostProcessor((t,e)=>{var f;if(this.isAdmin())return;let s=this.app.vault.getAbstractFileByPath(e.sourcePath);if(!s)return;let n=this.app.metadataCache.getFileCache(s),a=n==null?void 0:n.frontmatter;if(!a)return;let i=Array.isArray(a.dnd_access_groups)?a.dnd_access_groups:[];if(i.length===0)return;let u=typeof a.dnd_require_auth=="boolean"?a.dnd_require_auth:!0,c=this.state.isAuthenticated,l=u?c:!0,h=(f=this.state.currentGroups)!=null?f:[],p=i.some(A=>h.includes(A));if(l&&p)return;t.empty();let m=t.createDiv({cls:"authentificator-denied"});if(m.createEl("h3",{text:"Access denied \u{1F512}"}),!this.state.currentCharacter){m.createEl("p",{text:"No character selected."}),E(m,"Select character",()=>{this.execCommand("account-manager:authentificator-select-character")});return}this.state.isAuthenticated||(m.createEl("p",{text:"You must login to access this content."}),E(m,"Login",()=>{this.execCommand("account-manager:authentificator-login")})),E(m,"Open gated note\u2026",()=>{this.execCommand("account-manager:authentificator-open-gated-note")})})}onunload(){}renderStatus(){var n,a;if(!this.statusEl)return;let t=(n=this.state.currentCharacter)!=null?n:"none",e=this.state.isAuthenticated?"unlocked":"locked",s=this.isAdmin()?"ADMIN":(a=this.state.currentGroups)!=null&&a.length?this.state.currentGroups.join(","):"-";this.statusEl.setText(`authentificator: ${t} (${e}) [${s}]`)}execCommand(t){var e,s;(s=(e=this.app.commands)==null?void 0:e.executeCommandById)==null||s.call(e,t)}isAdmin(){return this.state.currentCharacter==="Admin"&&this.state.isAuthenticated}refreshAllMarkdownViews(){this.app.workspace.iterateAllLeaves(t=>{var s,n,a,i,u,c;let e=t.view;if(e&&((s=e.getViewType)==null?void 0:s.call(e))==="markdown"){(a=(n=e.previewMode)==null?void 0:n.rerender)==null||a.call(n,!0),(u=(i=e.currentMode)==null?void 0:i.rerender)==null||u.call(i,!0),(c=e.render)==null||c.call(e);let l=e.file;l&&t.openFile(l,{active:!1,state:t.getViewState().state}).catch(()=>{})}})}async ensureFolder(t){this.app.vault.getAbstractFileByPath(t)||await this.app.vault.createFolder(t).catch(()=>{})}async upsertFile(t,e){let s=this.app.vault.getAbstractFileByPath(t);if(s){await this.app.vault.modify(s,e);return}let n=t.lastIndexOf("/");if(n>0){let a=t.substring(0,n);await this.ensureFolder(a)}await this.app.vault.create(t,e).catch(()=>{})}async ensureUsersFile(){let t=this.app.vault.getAbstractFileByPath(C);if(!t){let s={users:[{name:"Admin",salt:"initAdminSalt",hash:"6fADYzT98VWr970cJ2rD/sEmthlRK9Xq71YHrXYZMZM=",groups:["admin","dm"]}]};return await this.upsertFile(C,JSON.stringify(s,null,2)),s}let e=await this.app.vault.read(t);return JSON.parse(e)}async loadUsers(){var e;return(e=(await this.ensureUsersFile()).users)!=null?e:[]}async saveUsers(t){let e=JSON.stringify({users:t},null,2);await this.upsertFile(C,e)}async generateUserReportNote(){var n;let t="Admin Area/UserReport.md",e=await this.loadUsers(),s=[];s.push("---"),s.push("dnd_access_groups: [admin]"),s.push("dnd_require_auth: true"),s.push("generated: true"),s.push("---"),s.push(""),s.push("# User Report"),s.push(""),s.push(`Updated: ${new Date().toISOString()}`),s.push(""),s.push("| User | Groups |"),s.push("|---|---|");for(let a of e)s.push(`| ${a.name} | ${((n=a.groups)!=null?n:[]).join(", ")||"-"} |`);return s.push(""),await this.upsertFile(t,s.join(`
`)),t}async verifyPassword(t,e){let n=(await this.loadUsers()).find(i=>i.name===t);return n?await S(`${n.salt}:${e}`)===n.hash:!1}canAccessFile(t){var u;if(this.isAdmin())return!0;let e=this.app.metadataCache.getFileCache(t),s=e==null?void 0:e.frontmatter;if(!s)return!1;let n=Array.isArray(s.dnd_access_groups)?s.dnd_access_groups:[];if(n.length===0||(typeof s.dnd_require_auth=="boolean"?s.dnd_require_auth:!0)&&!this.state.isAuthenticated)return!1;let i=(u=this.state.currentGroups)!=null?u:[];return n.some(c=>i.includes(c))}},k=class extends r.Modal{constructor(t,e,s){super(t);this.users=e;this.done=s}onOpen(){let{contentEl:t}=this;if(t.empty(),t.createEl("h3",{text:"Select character"}),!this.users.length)t.createEl("p",{text:"No users found."});else for(let s of this.users){let n=t.createEl("button",{text:s.name});n.addClass("am-modal-btn"),n.addEventListener("click",()=>{this.done(s),this.close()})}let e=t.createEl("button",{text:"Cancel"});e.addClass("am-modal-cancel"),e.addEventListener("click",()=>{this.done(null),this.close()})}onClose(){this.contentEl.empty()}},b=class extends r.Modal{constructor(t,e){super(t);this.done=e;this.value=""}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:"Enter password"});let e=t.createEl("input",{type:"password"});e.focus(),e.addEventListener("input",()=>this.value=e.value),new r.Setting(t).addButton(s=>s.setButtonText("OK").setCta().onClick(()=>{this.done(this.value),this.close()})).addButton(s=>s.setButtonText("Cancel").onClick(()=>{this.done(null),this.close()}))}onClose(){this.contentEl.empty()}},B=class extends r.Modal{constructor(t,e){super(t);this.done=e;this.name="";this.password="";this.groups=""}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:"Create / update user"});let e=t.createEl("input",{type:"text",placeholder:"User name (e.g. Castro)"});e.addEventListener("input",()=>this.name=e.value),e.focus();let s=t.createEl("input",{type:"password",placeholder:"Password"});s.addEventListener("input",()=>this.password=s.value);let n=t.createEl("input",{type:"text",placeholder:"Groups (comma separated), e.g. party, house_cannith"});n.addEventListener("input",()=>this.groups=n.value),new r.Setting(t).addButton(a=>a.setButtonText("Save").setCta().onClick(()=>{this.done({name:this.name,password:this.password,groups:this.groups}),this.close()})).addButton(a=>a.setButtonText("Cancel").onClick(()=>{this.done(null),this.close()}))}onClose(){this.contentEl.empty()}},g=class extends r.Modal{constructor(t,e,s,n){super(t);this.title=e;this.placeholder=s;this.done=n;this.value=""}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:this.title});let e=t.createEl("input",{type:"text",placeholder:this.placeholder});e.addEventListener("input",()=>this.value=e.value),e.focus(),new r.Setting(t).addButton(s=>s.setButtonText("Ok").setCta().onClick(()=>{this.done(this.value.trim()||null),this.close()})).addButton(s=>s.setButtonText("Cancel").onClick(()=>{this.done(null),this.close()}))}onClose(){this.contentEl.empty()}},U=class extends r.FuzzySuggestModal{constructor(t,e,s){super(t);this.users=e;this.done=s;this.hasResolved=!1;this.setPlaceholder("Pick a user\u2026")}getItems(){return this.users}getItemText(t){return t.name}onChooseItem(t){this.hasResolved||(this.hasResolved=!0,this.done(t),this.close())}onClose(){super.onClose(),!this.hasResolved&&(this.hasResolved=!0,this.done(null))}},P=class extends r.FuzzySuggestModal{constructor(t,e){super(t);this.plugin=e;this.setPlaceholder("Type to search gated notes\u2026")}getItems(){return this.plugin.app.vault.getMarkdownFiles().filter(e=>this.plugin.canAccessFile(e))}getItemText(t){return t.path}onChooseItem(t){this.handleChoose(t)}async handleChoose(t){await this.plugin.app.workspace.getLeaf(!0).openFile(t)}},T=class extends r.Modal{constructor(t,e){super(t);this.plugin=e}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:"Authentificator"}),new r.Setting(t).setName("Select character").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-select-character")})),new r.Setting(t).setName("Login (password)").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-login")})),new r.Setting(t).setName("Open gated note\u2026").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-open-gated-note")})),new r.Setting(t).setName("Logout").addButton(e=>e.setButtonText("Do it").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-logout")})),this.plugin.isAdmin()&&(t.createEl("hr"),new r.Setting(t).setName("Admin: create/update user").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-admin-create-update-user")})),new r.Setting(t).setName("Admin: toggle group for user").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-admin-toggle-group")})),new r.Setting(t).setName("Admin: toggle group for all players").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-admin-toggle-group-all")})),new r.Setting(t).setName("Admin: reset temporary groups").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-admin-reset-temp-groups")})),new r.Setting(t).setName("Admin: who has group?").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-admin-who-has-group")})))}onClose(){this.contentEl.empty()}};
