/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var C=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var D=Object.prototype.hasOwnProperty;var I=(u,o)=>{for(var t in o)C(u,t,{get:o[t],enumerable:!0})},L=(u,o,t,e)=>{if(o&&typeof o=="object"||typeof o=="function")for(let s of O(o))!D.call(u,s)&&s!==t&&C(u,s,{get:()=>o[s],enumerable:!(e=$(o,s))||e.enumerable});return u};var G=u=>L(C({},"__esModule",{value:!0}),u);var q={};I(q,{default:()=>v});module.exports=G(q);var a=require("obsidian"),y="DnDAuth/users.json",x={currentCharacter:null,isAuthenticated:!1,currentGroups:[]};function F(u){let o="";for(let t of u)o+=String.fromCharCode(t);return btoa(o)}async function S(u){let o=new TextEncoder().encode(u),t=await crypto.subtle.digest("SHA-256",o);return F(new Uint8Array(t))}function R(u=16){let o=new Uint8Array(u);return crypto.getRandomValues(o),F(o)}function M(u){if(!u||typeof u!="object")return!1;let o=u;return Array.isArray(o.users)}function E(u,o,t){let e=u.createEl("button",{text:o});e.addClass("am-action-btn"),e.addEventListener("click",t)}function N(u){let o=u.split(`
`),t=[],e=!0,s=0;for(let r=0;r<o.length;r++){let i=o[r];if(i===void 0)continue;let c=i.trim();if(c==="---"){s=r+1;break}if(!c)continue;let d=c.match(/^groups\s*:\s*(.+)$/i);if(d&&d[1]){t=d[1].split(",").map(h=>h.trim()).filter(Boolean);continue}let l=c.match(/^requireAuth\s*:\s*(true|false)$/i);if(l&&l[1]){e=l[1].toLowerCase()==="true";continue}}let n=o.slice(s).join(`
`);return{groups:t,body:n,requireAuth:e}}var v=class extends a.Plugin{constructor(){super(...arguments);this.state={...x};this.statusEl=null}async onload(){this.state={...x,...await this.loadData()},await this.ensureUsersFile(),this.statusEl=this.addStatusBarItem(),this.renderStatus(),this.statusEl&&(this.statusEl.addClass("am-status-clickable"),this.statusEl.addEventListener("click",()=>{new T(this.app,this).open()})),this.registerMarkdownCodeBlockProcessor("dndadmin",async(t,e)=>{var c;if(!this.isAdmin()){e.createEl("div",{text:"Admin only. \u{1F512}"});return}let s=e.createDiv(),n=s.createEl("button",{text:"Create / update user"});n.onclick=()=>{this.execCommand("account-manager:authentificator-admin-create-update-user")};let r=s.createEl("button",{text:"Regenerate report"});r.addClass("am-report-btn"),r.onclick=async()=>{await this.generateUserReportNote(),this.refreshAllMarkdownViews(),new a.Notice("Report updated")},e.createEl("hr");let i=await this.loadUsers();for(let d of i)e.createDiv({text:`${d.name} \u2014 ${((c=d.groups)!=null?c:[]).join(", ")||"-"}`})}),this.addCommand({id:"authentificator-admin-setup-admin-area",name:"Admin: setup admin area",callback:async()=>{if(!this.isAdmin()){new a.Notice("Admin only, please login as admin.");return}await this.ensureFolder("Admin Area"),await this.upsertFile("Admin Area/UserManagement.md",["---","dnd_access_groups: [admin]","dnd_require_auth: true","generated: true","---","","# Admin Area \u2013 User Management","","```dndadmin","mode: users","```",""].join(`
`)),await this.generateUserReportNote(),this.refreshAllMarkdownViews();let t=this.app.vault.getAbstractFileByPath("Admin Area/UserManagement.md");t instanceof a.TFile&&await this.app.workspace.getLeaf(!0).openFile(t),new a.Notice("Admin area created/updated.")}}),this.addCommand({id:"authentificator-select-character",name:"Select character",callback:async()=>{let t=await this.loadUsers(),e=await new Promise(s=>{new k(this.app,t,s).open()});e&&(this.state.currentCharacter=e.name,this.state.isAuthenticated=!1,this.state.currentGroups=[],await this.saveData(this.state),this.renderStatus(),this.refreshAllMarkdownViews(),new a.Notice(`Selected character: ${e.name}`))}}),this.addCommand({id:"authentificator-login",name:"Login (password)",callback:async()=>{var i;let t=this.state.currentCharacter;if(!t){new a.Notice("Select a character first.");return}let e=await new Promise(c=>{new b(this.app,c).open()});if(!e)return;if(!await this.verifyPassword(t,e)){this.state.isAuthenticated=!1,this.state.currentGroups=[],await this.saveData(this.state),this.renderStatus(),this.refreshAllMarkdownViews(),new a.Notice("Login failed.");return}let r=(await this.loadUsers()).find(c=>c.name===t);this.state.isAuthenticated=!0,this.state.currentGroups=((i=r==null?void 0:r.groups)!=null?i:[]).map(String),await this.saveData(this.state),this.renderStatus(),this.refreshAllMarkdownViews(),new a.Notice(`Logged in as ${t}`)}}),this.addCommand({id:"authentificator-logout",name:"Logout",callback:async()=>{this.state={...x},await this.saveData(this.state),this.renderStatus(),this.refreshAllMarkdownViews(),new a.Notice("Logged out.")}}),this.addCommand({id:"authentificator-open-gated-note",name:"Open gated note\u2026",callback:()=>{if(!this.isAdmin()&&!this.state.isAuthenticated){new a.Notice("Please login first.");return}new P(this.app,this).open()}}),this.addCommand({id:"authentificator-admin-create-update-user",name:"Admin: create/update user",callback:async()=>{if(!this.isAdmin()){new a.Notice("Admin only, please login as admin.");return}let t=await new Promise(p=>{new B(this.app,p).open()});if(!t)return;let e=t.name.trim(),s=t.password;if(!e)return void new a.Notice("User name cannot be empty.");if(!s)return void new a.Notice("Password cannot be empty.");let n=t.groups.split(",").map(p=>p.trim()).filter(Boolean);e==="Admin"&&!n.includes("admin")&&n.push("admin");let r=await this.loadUsers(),i=R(),c=await S(`${i}:${s}`),d=r.findIndex(p=>p.name===e),l={name:e,salt:i,hash:c,groups:n},h;d>=0?h=l:r.push(l),await this.saveUsers(r),this.refreshAllMarkdownViews(),new a.Notice(`\u2705 Saved user: ${e}`)}}),this.addCommand({id:"authentificator-admin-toggle-group",name:"Admin: toggle group for user",callback:async()=>{var h,p,f,m,A;if(!this.isAdmin()){new a.Notice("Admin only, please login as admin.");return}let t=await new Promise(g=>{new w(this.app,"Toggle group","Group name (e.g. session_07_reveal)",g).open()});if(!t)return;let e=t.trim(),s=await this.loadUsers(),n=await new Promise(g=>{new U(this.app,s.filter(_=>_.name!=="Admin"),g).open()});if(!n)return;let r=s.findIndex(g=>g.name===n.name);if(r<0)return;let i=s[r];if(!i)return;let c=new Set(((h=i.groups)!=null?h:[]).map(String));i.groups=Array.from(c),this.state.currentCharacter===i.name&&this.state.isAuthenticated&&(this.state.currentGroups=(p=i.groups)!=null?p:[]),await this.saveUsers(s),this.state.currentCharacter===i.name&&this.state.isAuthenticated&&(this.state.currentGroups=(f=i.groups)!=null?f:[],await this.saveData(this.state),this.renderStatus()),this.refreshAllMarkdownViews();let l=((A=(m=i.groups)==null?void 0:m.includes(e))!=null?A:!1)?"added":"removed";new a.Notice(`\u2705 ${l.toUpperCase()}: "${e}" ${l==="added"?"to":"from"} ${n.name}`)}}),this.addCommand({id:"authentificator-admin-toggle-group-all",name:"Admin: toggle group for all players",callback:async()=>{var c;if(!this.isAdmin()){new a.Notice("Admin only, please login as admin.");return}let t=await new Promise(d=>{new w(this.app,"Toggle group for ALL","Group name (e.g. session_07_reveal)",d).open()});if(!t)return;let e=t.trim(),s=await this.loadUsers(),n=s.filter(d=>d.name!=="Admin"),i=n.filter(d=>{var l;return((l=d.groups)!=null?l:[]).includes(e)}).length<Math.ceil(n.length/2);for(let d of n){let l=new Set(((c=d.groups)!=null?c:[]).map(String));i?l.add(e):l.delete(e),d.groups=Array.from(l)}await this.saveUsers(s),this.refreshAllMarkdownViews(),new a.Notice(`\u2705 ${i?"Added":"Removed"} "${e}" ${i?"to":"from"} ALL players`)}}),this.addCommand({id:"authentificator-admin-reset-temp-groups",name:"Admin: reset temporary groups",callback:async()=>{var n;if(!this.isAdmin()){new a.Notice("Admin only, please login as admin.");return}let t=await new Promise(r=>{new w(this.app,"Reset temporary groups","Prefix (default: session_)",r).open()}),e=t&&t.trim().length>0?t.trim():"session_",s=await this.loadUsers();for(let r of s)r.name!=="Admin"&&(r.groups=((n=r.groups)!=null?n:[]).filter(i=>!String(i).startsWith(e)));await this.saveUsers(s),this.refreshAllMarkdownViews(),new a.Notice(`Removed all groups starting with "${e}" from all players`)}}),this.addCommand({id:"authentificator-admin-who-has-group",name:"Admin: who has group?",callback:async()=>{if(!this.isAdmin()){new a.Notice("Admin only, please login as admin.");return}let t=await new Promise(r=>{new w(this.app,"Who has group?","Group name (e.g. party)",r).open()});if(!t)return;let e=t.trim(),n=(await this.loadUsers()).filter(r=>r.name!=="Admin").filter(r=>{var i;return((i=r.groups)!=null?i:[]).includes(e)}).map(r=>r.name);new a.Notice(n.length?`\u2705 "${e}" holders: ${n.join(", ")}`:`\u2139\uFE0F Nobody has "${e}"`)}}),this.registerMarkdownCodeBlockProcessor("dndgate",async(t,e,s)=>{var p;let n=N(t),r=new a.Component;if(this.register(()=>r.unload()),this.isAdmin()){await a.MarkdownRenderer.render(this.app,n.body.trim(),e,s.sourcePath,r);return}let i=this.state.isAuthenticated,c=n.requireAuth?i:!0,d=n.groups,l=(p=this.state.currentGroups)!=null?p:[],h=d.length>0&&d.some(f=>l.includes(f));if(!c||!h){e.createEl("div",{text:"Access denied. \u{1F512}"});return}await a.MarkdownRenderer.render(this.app,n.body.trim(),e,s.sourcePath,r)}),this.registerMarkdownPostProcessor((t,e)=>{var A;if(this.isAdmin())return;let s=this.app.vault.getAbstractFileByPath(e.sourcePath);if(!(s instanceof a.TFile))return;let n=this.app.metadataCache.getFileCache(s),r=n==null?void 0:n.frontmatter;if(!r)return;let i=r.dnd_access_groups,c=Array.isArray(i)?i.map(g=>String(g)):[];if(c.length===0)return;let d=typeof r.dnd_require_auth=="boolean"?r.dnd_require_auth:!0,l=this.state.isAuthenticated,h=d?l:!0,p=(A=this.state.currentGroups)!=null?A:[],f=c.some(g=>p.includes(g));if(h&&f)return;t.empty();let m=t.createDiv({cls:"authentificator-denied"});if(m.createEl("h3",{text:"Access denied"}),!this.state.currentCharacter){m.createEl("p",{text:"No character selected."}),E(m,"Select character",()=>{this.execCommand("account-manager:authentificator-select-character")});return}this.state.isAuthenticated||(m.createEl("p",{text:"You must login to access this content."}),E(m,"Login",()=>{this.execCommand("account-manager:authentificator-login")})),E(m,"Open gated note\u2026",()=>{this.execCommand("account-manager:authentificator-open-gated-note")})})}onunload(){}renderStatus(){var n,r;if(!this.statusEl)return;let t=(n=this.state.currentCharacter)!=null?n:"none",e=this.state.isAuthenticated?"unlocked":"locked",s=this.isAdmin()?"ADMIN":(r=this.state.currentGroups)!=null&&r.length?this.state.currentGroups.join(","):"-";this.statusEl.setText(`authentificator: ${t} (${e}) [${s}]`)}execCommand(t){this.app.commands.executeCommandById(t)}isAdmin(){return this.state.currentCharacter==="Admin"&&this.state.isAuthenticated}refreshAllMarkdownViews(){let t=this.app.workspace.getLeavesOfType("markdown");for(let e of t){let s=e.view;if(!(s instanceof a.MarkdownView))continue;let n=s.file;n instanceof a.TFile&&e.openFile(n,{active:!1})}}async ensureFolder(t){this.app.vault.getAbstractFileByPath(t)||await this.app.vault.createFolder(t).catch(()=>{})}async upsertFile(t,e){let s=this.app.vault.getAbstractFileByPath(t);if(s instanceof a.TFile){await this.app.vault.modify(s,e);return}if(s)throw new Error(`Cannot write file because a folder exists at: ${t}`);let n=t.lastIndexOf("/");if(n>0){let r=t.substring(0,n);await this.ensureFolder(r)}await this.app.vault.create(t,e)}async ensureUsersFile(){let t=this.app.vault.getAbstractFileByPath(y);if(!t){let n={users:[{name:"Admin",salt:"initAdminSalt",hash:"6fADYzT98VWr970cJ2rD/sEmthlRK9Xq71YHrXYZMZM=",groups:["admin","dm"]}]};return await this.upsertFile(y,JSON.stringify(n,null,2)),n}if(!(t instanceof a.TFile))throw new Error(`Users path exists but is not a file: ${y}`);let e=await this.app.vault.read(t),s=JSON.parse(e);if(!M(s))throw new Error(`Invalid users.json format at ${y}`);return s}async loadUsers(){var e;return(e=(await this.ensureUsersFile()).users)!=null?e:[]}async saveUsers(t){let e=JSON.stringify({users:t},null,2);await this.upsertFile(y,e)}async generateUserReportNote(){var n;let t="Admin Area/UserReport.md",e=await this.loadUsers(),s=[];s.push("---"),s.push("dnd_access_groups: [admin]"),s.push("dnd_require_auth: true"),s.push("generated: true"),s.push("---"),s.push(""),s.push("# User Report"),s.push(""),s.push(`Updated: ${new Date().toISOString()}`),s.push(""),s.push("| User | Groups |"),s.push("|---|---|");for(let r of e)s.push(`| ${r.name} | ${((n=r.groups)!=null?n:[]).join(", ")||"-"} |`);return s.push(""),await this.upsertFile(t,s.join(`
`)),t}async verifyPassword(t,e){let n=(await this.loadUsers()).find(i=>i.name===t);return n?await S(`${n.salt}:${e}`)===n.hash:!1}canAccessFile(t){var c;if(this.isAdmin())return!0;let e=this.app.metadataCache.getFileCache(t),s=e==null?void 0:e.frontmatter;if(!s)return!1;let n=Array.isArray(s.dnd_access_groups)?s.dnd_access_groups:[];if(n.length===0||(typeof s.dnd_require_auth=="boolean"?s.dnd_require_auth:!0)&&!this.state.isAuthenticated)return!1;let i=(c=this.state.currentGroups)!=null?c:[];return n.some(d=>i.includes(d))}},k=class extends a.Modal{constructor(t,e,s){super(t);this.users=e;this.done=s}onOpen(){let{contentEl:t}=this;if(t.empty(),t.createEl("h3",{text:"Select character"}),!this.users.length)t.createEl("p",{text:"No users found."});else for(let s of this.users){let n=t.createEl("button",{text:s.name});n.addClass("am-modal-btn"),n.addEventListener("click",()=>{this.done(s),this.close()})}let e=t.createEl("button",{text:"Cancel"});e.addClass("am-modal-cancel"),e.addEventListener("click",()=>{this.done(null),this.close()})}onClose(){this.contentEl.empty()}},b=class extends a.Modal{constructor(t,e){super(t);this.done=e;this.value=""}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:"Enter password"});let e=t.createEl("input",{type:"password"});e.focus(),e.addEventListener("input",()=>this.value=e.value),new a.Setting(t).addButton(s=>s.setButtonText("OK").setCta().onClick(()=>{this.done(this.value),this.close()})).addButton(s=>s.setButtonText("Cancel").onClick(()=>{this.done(null),this.close()}))}onClose(){this.contentEl.empty()}},B=class extends a.Modal{constructor(t,e){super(t);this.done=e;this.name="";this.password="";this.groups=""}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:"Create / update user"});let e=t.createEl("input",{type:"text",placeholder:"User name (e.g. Castro)"});e.addEventListener("input",()=>this.name=e.value),e.focus();let s=t.createEl("input",{type:"password",placeholder:"Password"});s.addEventListener("input",()=>this.password=s.value);let n=t.createEl("input",{type:"text",placeholder:"Groups (comma separated), e.g. party, house_cannith"});n.addEventListener("input",()=>this.groups=n.value),new a.Setting(t).addButton(r=>r.setButtonText("Save").setCta().onClick(()=>{this.done({name:this.name,password:this.password,groups:this.groups}),this.close()})).addButton(r=>r.setButtonText("Cancel").onClick(()=>{this.done(null),this.close()}))}onClose(){this.contentEl.empty()}},w=class extends a.Modal{constructor(t,e,s,n){super(t);this.title=e;this.placeholder=s;this.done=n;this.value=""}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:this.title});let e=t.createEl("input",{type:"text",placeholder:this.placeholder});e.addEventListener("input",()=>this.value=e.value),e.focus(),new a.Setting(t).addButton(s=>s.setButtonText("OK").setCta().onClick(()=>{this.done(this.value.trim()||null),this.close()})).addButton(s=>s.setButtonText("Cancel").onClick(()=>{this.done(null),this.close()}))}onClose(){this.contentEl.empty()}},U=class extends a.FuzzySuggestModal{constructor(t,e,s){super(t);this.users=e;this.done=s;this.hasResolved=!1;this.setPlaceholder("Pick a user\u2026")}getItems(){return this.users}getItemText(t){return t.name}onChooseItem(t){this.hasResolved||(this.hasResolved=!0,this.done(t),this.close())}onClose(){super.onClose(),!this.hasResolved&&(this.hasResolved=!0,this.done(null))}},P=class extends a.FuzzySuggestModal{constructor(t,e){super(t);this.plugin=e;this.setPlaceholder("Type to search gated notes.")}getItems(){return this.plugin.app.vault.getMarkdownFiles().filter(e=>this.plugin.canAccessFile(e))}getItemText(t){return t.path}onChooseItem(t){this.handleChoose(t)}async handleChoose(t){await this.plugin.app.workspace.getLeaf(!0).openFile(t)}},T=class extends a.Modal{constructor(t,e){super(t);this.plugin=e}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:"Authentificator"}),new a.Setting(t).setName("Select character").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-select-character")})),new a.Setting(t).setName("Login (password)").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-login")})),new a.Setting(t).setName("Open gated note\u2026").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-open-gated-note")})),new a.Setting(t).setName("Logout").addButton(e=>e.setButtonText("Do it").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-logout")})),this.plugin.isAdmin()&&(t.createEl("hr"),new a.Setting(t).setName("Admin: create or update user").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.execCommand("account-manager:authentificator-admin-create-update-user")})),new a.Setting(t).setName("Admin: toggle group for user").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-admin-toggle-group")})),new a.Setting(t).setName("Admin: toggle group for all players").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-admin-toggle-group-all")})),new a.Setting(t).setName("Admin: reset temporary groups").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-admin-reset-temp-groups")})),new a.Setting(t).setName("Admin: who has group?").addButton(e=>e.setButtonText("Open").onClick(()=>{this.close(),this.plugin.app.commands.executeCommandById("account-manager:authentificator-admin-who-has-group")})))}onClose(){this.contentEl.empty()}};
